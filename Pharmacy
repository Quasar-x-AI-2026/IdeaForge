
import React, { useState, useEffect, useRef } from 'react';
import { 
  ShoppingBag, Pill, Search, MapPin, Plus, Loader2, Star, CheckCircle2, 
  ChevronRight, Store, PhoneCall, Navigation, ExternalLink, PackageCheck, 
  HeartPulse, X, Minus, Trash2, Clock, Truck, Globe, Map as MapIcon, 
  Sparkles, FileText, Upload, CreditCard, ChevronLeft, Check, Info, Filter,
  Share2
} from 'lucide-react';
import { searchNearbyPlaces, scanStatePharmacies } from '../services/geminiService';
import { Medicine } from '../types';
import { STATES_CITIES } from '../data';

const MOCK_MEDS: (Medicine & { requiresPrescription?: boolean })[] = [
  { id: 'm1', name: 'Paracetamol 500mg', brand: 'Crocin', price: 45, category: 'Fever', image: 'ðŸ’Š', requiresPrescription: false },
  { id: 'm2', name: 'Amoxicillin 500mg', brand: 'Novamox', price: 88, category: 'First Aid', image: 'ðŸ§ª', requiresPrescription: true },
  { id: 'm3', name: 'Antacid Gel', brand: 'Digene', price: 120, category: 'Digestive', image: 'ðŸ¥¤', requiresPrescription: false },
  { id: 'm4', name: 'Cetirizine', brand: 'Okacet', price: 25, category: 'Pain', image: 'ðŸ¤§', requiresPrescription: false },
  { id: 'm5', name: 'Insulin Glargine', brand: 'Lantus', price: 650, category: 'Diabetes', image: 'ðŸ’‰', requiresPrescription: true },
  { id: 'm6', name: 'Dettol Liquid', brand: 'Reckitt', price: 85, category: 'First Aid', image: 'ðŸ©¹', requiresPrescription: false },
];

interface Order {
  id: string;
  date: string;
  items: { name: string; qty: number }[];
  total: number;
  status: 'Delivered' | 'Out for Delivery' | 'Processing';
  hasPrescription?: boolean;
}

const PharmacyView: React.FC = () => {
  const [searchTerm, setSearchTerm] = useState('');
  const [stateSearchTerm, setStateSearchTerm] = useState('');
  const [cart, setCart] = useState<{id: string, qty: number}[]>([]);
  const [orders, setOrders] = useState<Order[]>([
    {
      id: 'HQ-8821-XP',
      date: '24 May, 2024',
      items: [{ name: 'Paracetamol 500mg', qty: 2 }],
      total: 90,
      status: 'Delivered'
    }
  ]);

  const [isCartOpen, setIsCartOpen] = useState(false);
  const [isHistoryOpen, setIsHistoryOpen] = useState(false);
  const [checkoutStep, setCheckoutStep] = useState<'cart' | 'prescription' | 'checkout' | 'success'>('cart');
  const [prescriptionFile, setPrescriptionFile] = useState<string | null>(null);
  const [paymentMethod, setPaymentMethod] = useState<'upi' | 'cod'>('upi');

  const [loadingStores, setLoadingStores] = useState(false);
  const [stores, setStores] = useState<{ text: string; links: string[] } | null>(null);
  const [location, setLocation] = useState<{ lat: number; lng: number } | null>(null);
  const [selectedCategory, setSelectedCategory] = useState<string | null>(null);
  const [isOrdering, setIsOrdering] = useState(false);

  // State Scanning State
  const [scanningState, setScanningState] = useState<string | null>(null);
  const [stateScanResults, setStateScanResults] = useState<{ text: string; sources: any[] } | null>(null);
  const [isScanningState, setIsScanningState] = useState(false);

  const fileInputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    const initLocation = () => {
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            setLocation(coords);
            handleSearchStores(coords.lat, coords.lng);
          },
          (err) => {
            console.error("Geolocation denied", err);
            const defaultCoords = { lat: 28.6139, lng: 77.2090 };
            setLocation(defaultCoords);
            handleSearchStores(defaultCoords.lat, defaultCoords.lng);
          }
        );
      }
    };
    initLocation();
  }, []);

  const handleSearchStores = async (lat: number, lng: number) => {
    setLoadingStores(true);
    const data = await searchNearbyPlaces('pharmacy', lat, lng);
    setStores(data);
    setLoadingStores(false);
  };

  const handleStateScan = async (state: string) => {
    setScanningState(state);
    setIsScanningState(true);
    const results = await scanStatePharmacies(state);
    setStateScanResults(results);
    setIsScanningState(false);
  };

  const addToCart = (id: string) => {
    setCart(prev => {
      const existing = prev.find(item => item.id === id);
      if (existing) {
        return prev.map(item => item.id === id ? { ...item, qty: item.qty + 1 } : item);
      }
      return [...prev, { id, qty: 1 }];
    });
  };

  const removeFromCart = (id: string) => {
    setCart(prev => prev.filter(item => item.id !== id));
  };

  const updateQty = (id: string, delta: number) => {
    setCart(prev => prev.map(item => {
      if (item.id === id) {
        const newQty = Math.max(1, item.qty + delta);
        return { ...item, qty: newQty };
      }
      return item;
    }));
  };

  const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setPrescriptionFile(file.name);
    }
  };

  const cartItems = cart.map(item => ({
    ...MOCK_MEDS.find(m => m.id === item.id)!,
    qty: item.qty
  }));

  const cartTotal = cartItems.reduce((acc, item) => acc + (item.price * item.qty), 0);
  const needsPrescription = cartItems.some(item => item.requiresPrescription);

  const handleNextStep = () => {
    if (checkoutStep === 'cart') {
      if (needsPrescription && !prescriptionFile) {
        setCheckoutStep('prescription');
      } else {
        setCheckoutStep('checkout');
      }
    } else if (checkoutStep === 'prescription') {
      setCheckoutStep('checkout');
    }
  };

  const placeOrder = () => {
    setIsOrdering(true);
    setTimeout(() => {
      const newOrder: Order = {
        id: `HQ-${Math.floor(1000 + Math.random() * 9000)}-${Math.random().toString(36).substr(2, 2).toUpperCase()}`,
        date: new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }),
        items: cartItems.map(i => ({ name: i.name, qty: i.qty })),
        total: cartTotal,
        status: 'Processing',
        hasPrescription: !!prescriptionFile
      };
      setOrders([newOrder, ...orders]);
      setIsOrdering(false);
      setCheckoutStep('success');
      setCart([]);
      setPrescriptionFile(null);
    }, 2000);
  };

  const categories = ['All', 'Fever', 'Pain', 'Digestive', 'Heart', 'Diabetes', 'First Aid'];

  const filteredMeds = MOCK_MEDS.filter(m => {
    const matchesSearch = m.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                         m.brand.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesCategory = !selectedCategory || selectedCategory === 'All' || m.category === selectedCategory;
    return matchesSearch && matchesCategory;
  });

  const filteredStates = STATES_CITIES.filter(s => 
    s.state.toLowerCase().includes(stateSearchTerm.toLowerCase())
  );

  const janAushadhiCentres = [
    { name: 'Jan Aushadhi Kendra #1024', location: 'Near District Hospital', status: 'Open 24/7', rating: 4.8 },
    { name: 'PMBJK - Generic Medicine Hub', location: 'Main Market Square', status: 'Closes 10 PM', rating: 4.5 }
  ];

  return (
    <div className="max-w-7xl mx-auto px-4 py-8 space-y-12 relative">
      {/* Hero Header */}
      <div className="bg-green-600 rounded-[3rem] p-8 md:p-12 text-white shadow-2xl shadow-green-100 flex flex-col md:flex-row justify-between items-center gap-8 overflow-hidden relative">
        <div className="relative z-10 space-y-4 text-center md:text-left">
          <div className="inline-flex items-center gap-2 bg-white/20 px-4 py-1.5 rounded-full backdrop-blur-md">
            <PackageCheck size={16} />
            <span className="text-xs font-black uppercase tracking-widest">Verified Pharmacy Network</span>
          </div>
          <h1 className="text-5xl font-black tracking-tighter leading-none">HealQ Pharmacy</h1>
          <p className="text-green-100 text-lg font-medium max-w-md">
            Order medicine essentials or discover 5000+ government-verified Jan Aushadhi generic centres.
          </p>
          <div className="flex flex-wrap gap-3 justify-center md:justify-start pt-4">
            <button 
              onClick={() => { setIsCartOpen(true); setCheckoutStep('cart'); }}
              className="bg-white text-green-700 px-6 py-4 rounded-2xl font-black flex items-center gap-2 shadow-xl hover:bg-slate-50 transition-all active:scale-95 relative"
            >
              <ShoppingBag size={20} />
              View Cart
              {cart.length > 0 && (
                <span className="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] w-6 h-6 rounded-full flex items-center justify-center font-black border-2 border-white animate-bounce">
                  {cart.reduce((a, b) => a + b.qty, 0)}
                </span>
              )}
            </button>
            <button 
              onClick={() => setIsHistoryOpen(true)}
              className="bg-slate-900 text-white px-6 py-4 rounded-2xl font-black flex items-center gap-2 hover:bg-black transition-all"
            >
              <Clock size={20} />
              Track Orders
            </button>
          </div>
        </div>
        
        {/* Prescription Upload Card */}
        <div className="shrink-0 bg-white/10 p-8 rounded-[3rem] backdrop-blur-xl border border-white/20 relative z-10 flex flex-col items-center gap-4 text-center w-full max-w-xs md:w-auto">
          <div className="w-16 h-16 bg-white rounded-2xl flex items-center justify-center text-green-600 shadow-lg">
            <FileText size={32} />
          </div>
          <div className="space-y-1">
            <h3 className="font-black text-lg">Quick Order</h3>
            <p className="text-xs font-medium opacity-70">Upload prescription and let our AI handle the rest.</p>
          </div>
          <button 
            onClick={() => fileInputRef.current?.click()}
            className="w-full bg-white text-slate-900 py-3 rounded-xl font-bold text-sm hover:bg-slate-100 transition-all flex items-center justify-center gap-2"
          >
            <Upload size={16} />
            Upload Now
          </button>
          <input type="file" ref={fileInputRef} onChange={handleFileUpload} className="hidden" accept="image/*,.pdf" />
          {prescriptionFile && (
             <div className="flex items-center gap-2 text-[10px] font-bold bg-green-500/20 px-3 py-1 rounded-full text-green-200">
               <Check size={12} /> {prescriptionFile}
             </div>
          )}
        </div>

        <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -mr-20 -mt-20 blur-3xl"></div>
        <div className="absolute bottom-0 left-0 w-64 h-64 bg-black/5 rounded-full -ml-20 -mb-20 blur-2xl"></div>
      </div>

      {/* Jan Aushadhi Highlights */}
      <div className="space-y-6">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-orange-100 text-orange-600 rounded-xl">
              <HeartPulse size={24} />
            </div>
            <h2 className="text-2xl font-black text-slate-800 tracking-tight">Jan Aushadhi Kendras</h2>
          </div>
          <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest bg-slate-100 px-3 py-1 rounded-lg">Verified Govt. Centres</span>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {janAushadhiCentres.map((centre, i) => (
            <div key={i} className="bg-white border-2 border-orange-100 rounded-[2rem] p-6 flex flex-col sm:flex-row justify-between items-center gap-6 hover:shadow-lg transition-all">
              <div className="flex items-center gap-4 text-center sm:text-left">
                <div className="w-16 h-16 bg-orange-50 rounded-2xl flex items-center justify-center text-orange-500 font-black text-2xl">
                  JA
                </div>
                <div>
                  <h3 className="text-xl font-bold text-slate-900">{centre.name}</h3>
                  <p className="text-sm text-slate-500 font-medium flex items-center gap-1.5 justify-center sm:justify-start">
                    <MapPin size={14} /> {centre.location}
                  </p>
                  <div className="flex items-center gap-2 mt-2 justify-center sm:justify-start">
                    <span className="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-md font-bold uppercase">{centre.status}</span>
                    <div className="flex items-center gap-1 text-yellow-500 text-xs font-bold">
                      <Star size={12} fill="currentColor" /> {centre.rating}
                    </div>
                  </div>
                </div>
              </div>
              <div className="flex gap-2 w-full sm:w-auto">
                <a 
                   href={`https://www.google.com/maps/search/Jan+Aushadhi+Kendra/@${location?.lat},${location?.lng},14z`}
                   target="_blank" 
                   rel="noopener noreferrer"
                   className="flex-grow sm:flex-none bg-slate-900 text-white px-6 py-3 rounded-xl font-bold text-sm hover:bg-black transition-all text-center"
                >
                  Navigate
                </a>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* National Pharmacy Hub Explorer */}
      <div className="space-y-8">
        <div className="flex flex-col md:flex-row md:items-end justify-between gap-4">
          <div className="space-y-2">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-blue-100 text-blue-600 rounded-xl">
                <Globe size={24} />
              </div>
              <h2 className="text-3xl font-black text-slate-800 tracking-tight leading-none">National Pharmacy Hub Explorer</h2>
            </div>
            <p className="text-slate-500 font-medium max-w-xl">AI-scanned distribution centres, generic medicine warehouses, and pharmaceutical hubs across India.</p>
          </div>
          
          <div className="relative w-full md:w-72 group">
            <input 
              type="text" 
              placeholder="Filter by State..."
              value={stateSearchTerm}
              onChange={(e) => setStateSearchTerm(e.target.value)}
              className="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-2xl focus:border-blue-500 outline-none transition-all text-sm font-bold shadow-sm"
            />
            <Search className="absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-blue-500 transition-colors" size={16} />
          </div>
        </div>

        <div className="bg-white rounded-[3rem] border border-slate-100 p-8 shadow-xl shadow-slate-100">
          <div className="grid lg:grid-cols-4 gap-12">
            {/* State List Panel */}
            <div className="lg:col-span-1 space-y-6">
              <div className="flex items-center gap-2 text-slate-400 mb-2">
                <Filter size={14} />
                <span className="text-[10px] font-black uppercase tracking-widest">Select Region</span>
              </div>
              <div className="max-h-[500px] overflow-y-auto pr-2 custom-scrollbar space-y-2">
                {filteredStates.map(s => (
                  <button
                    key={s.state}
                    onClick={() => handleStateScan(s.state)}
                    className={`w-full text-left p-4 rounded-2xl font-bold text-sm transition-all flex items-center justify-between group ${scanningState === s.state ? 'bg-blue-600 text-white shadow-lg' : 'bg-slate-50 text-slate-600 hover:bg-slate-100'}`}
                  >
                    <span className="truncate">{s.state}</span>
                    {scanningState === s.state ? (
                      isScanningState ? <Loader2 size={16} className="animate-spin" /> : <CheckCircle2 size={16} />
                    ) : (
                      <ChevronRight size={16} className="opacity-0 group-hover:opacity-40 transition-opacity" />
                    )}
                  </button>
                ))}
                {filteredStates.length === 0 && (
                  <div className="py-10 text-center opacity-30">
                    <MapIcon className="mx-auto mb-2" />
                    <p className="text-xs font-bold">No results</p>
                  </div>
                )}
              </div>
            </div>

            {/* Results Display Area */}
            <div className="lg:col-span-3 min-h-[500px] border-l border-slate-50 pl-0 lg:pl-12">
              {scanningState ? (
                <div className="space-y-8 animate-in fade-in slide-in-from-right-4 duration-500">
                  <div className="flex flex-col md:flex-row md:items-center justify-between gap-6">
                    <div className="flex items-center gap-4">
                       <div className="w-16 h-16 bg-blue-100 rounded-[1.5rem] flex items-center justify-center text-blue-600 shadow-inner">
                         <MapIcon size={32} />
                       </div>
                       <div>
                         <h3 className="text-2xl font-black text-slate-900">{scanningState} Intelligence</h3>
                         <div className="flex items-center gap-2 text-xs font-bold text-slate-400 mt-1 uppercase tracking-widest">
                           <Sparkles size={14} className="text-blue-500" />
                           Aisha Live Verification Enabled
                         </div>
                       </div>
                    </div>
                    <button className="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold text-sm flex items-center gap-2 hover:bg-black transition-all">
                      <Share2 size={16} /> Export Hub Data
                    </button>
                  </div>

                  {isScanningState ? (
                    <div className="py-24 flex flex-col items-center justify-center text-center space-y-6">
                      <div className="relative">
                        <div className="w-24 h-24 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin"></div>
                        <Sparkles className="absolute inset-0 m-auto text-blue-400 animate-pulse" size={32} />
                      </div>
                      <div className="space-y-2">
                        <h4 className="text-xl font-black text-slate-800">Scanned verified repositories...</h4>
                        <p className="text-slate-400 font-medium">Analyzing State Medical Corporation depots and private clusters in {scanningState}</p>
                      </div>
                    </div>
                  ) : stateScanResults ? (
                    <div className="grid md:grid-cols-3 gap-8">
                      <div className="md:col-span-2 space-y-8">
                        <div className="bg-slate-50 p-8 rounded-[2.5rem] border border-blue-50 relative overflow-hidden group">
                          <div className="prose prose-slate prose-lg max-w-none relative z-10">
                            <div className="text-slate-700 leading-relaxed font-medium whitespace-pre-wrap">
                              {stateScanResults.text}
                            </div>
                          </div>
                          <div className="absolute top-0 right-0 w-48 h-48 bg-blue-500/5 rounded-full -mr-24 -mt-24 blur-3xl group-hover:bg-blue-500/10 transition-colors"></div>
                        </div>

                        {stateScanResults.sources.length > 0 && (
                          <div className="space-y-4">
                            <h4 className="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2">
                              <Info size={14} /> Intelligence Sources & Citations
                            </h4>
                            <div className="grid sm:grid-cols-2 gap-3">
                              {stateScanResults.sources.map((src, i) => (
                                <a 
                                  key={i} 
                                  href={src.web?.uri} 
                                  target="_blank" 
                                  rel="noopener noreferrer" 
                                  className="bg-white border border-slate-100 p-4 rounded-2xl hover:border-blue-300 hover:shadow-lg transition-all flex items-center justify-between group"
                                >
                                  <div className="flex items-center gap-3">
                                    <div className="w-8 h-8 bg-slate-50 rounded-lg flex items-center justify-center text-slate-400 group-hover:text-blue-600 transition-colors">
                                      <Globe size={16} />
                                    </div>
                                    <span className="text-xs font-bold text-slate-600 truncate max-w-[150px]">
                                      {src.web?.title || `Data Source ${i+1}`}
                                    </span>
                                  </div>
                                  <ExternalLink size={14} className="opacity-20 group-hover:opacity-100 transition-opacity" />
                                </a>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>

                      <div className="md:col-span-1 space-y-6">
                        <div className="bg-slate-900 rounded-[2rem] p-8 text-white space-y-6 shadow-2xl">
                          <h4 className="font-black uppercase tracking-tight text-blue-400 text-xs">Regional Logistics</h4>
                          <div className="space-y-4">
                            <div className="p-4 bg-white/5 rounded-2xl border border-white/10">
                              <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">State Efficiency</p>
                              <div className="flex items-center gap-2">
                                <div className="flex-grow h-2 bg-white/10 rounded-full overflow-hidden">
                                   <div className="h-full bg-blue-500 w-[85%] rounded-full"></div>
                                </div>
                                <span className="text-xs font-bold">85%</span>
                              </div>
                            </div>
                            <div className="p-4 bg-white/5 rounded-2xl border border-white/10">
                              <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Distribution Type</p>
                              <p className="font-bold">Mixed Public-Private</p>
                            </div>
                          </div>
                          <a 
                            href={`https://www.google.com/maps/search/major+medical+distributors+in+${scanningState}/@${location?.lat},${location?.lng},8z`}
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold transition-all flex items-center justify-center gap-2 shadow-lg shadow-blue-900/40"
                          >
                            <Navigation size={18} />
                            View Distribution Map
                          </a>
                        </div>
                        
                        <div className="bg-blue-50 p-6 rounded-[2rem] border border-blue-100 flex gap-4">
                           <div className="bg-blue-600/10 p-3 rounded-xl text-blue-600 shrink-0 h-fit">
                             <Sparkles size={20} />
                           </div>
                           <div>
                             <p className="text-[10px] font-black text-blue-600 uppercase tracking-widest mb-1">Aisha Recommendation</p>
                             <p className="text-sm font-medium text-blue-900 leading-relaxed italic">
                               "Institutional hubs in {scanningState} often have surplus stock of high-demand medications. Check major city depots first."
                             </p>
                           </div>
                        </div>
                      </div>
                    </div>
                  ) : null}
                </div>
              ) : (
                <div className="h-full flex flex-col items-center justify-center text-center p-12 space-y-8">
                  <div className="w-32 h-32 bg-slate-50 rounded-[2.5rem] flex items-center justify-center text-slate-200 mb-4 animate-in zoom-in duration-700">
                    <Globe size={64} />
                  </div>
                  <div className="space-y-2">
                    <h3 className="text-2xl font-black text-slate-400">Scan Regional Pharmacy Networks</h3>
                    <p className="text-slate-300 font-medium max-w-sm mx-auto">Select a state from the left panel to trigger an AI scan of verified medical hubs and warehouses.</p>
                  </div>
                  <div className="flex gap-4">
                    <div className="flex items-center gap-2 text-[10px] font-black text-slate-300 uppercase tracking-widest px-4 py-2 bg-slate-50 rounded-lg">
                      <CheckCircle2 size={12} /> Live Grounding
                    </div>
                    <div className="flex items-center gap-2 text-[10px] font-black text-slate-300 uppercase tracking-widest px-4 py-2 bg-slate-50 rounded-lg">
                      <CheckCircle2 size={12} /> Govt Registry
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>

      <div className="grid lg:grid-cols-3 gap-8">
        <div className="lg:col-span-2 space-y-8">
          {/* Filters & Search */}
          <div className="flex flex-col gap-6">
            <div className="relative">
              <input 
                type="text" 
                placeholder="Search medicines, brands, or health needs..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full pl-14 pr-4 py-5 rounded-[1.5rem] border-2 border-slate-200 focus:border-green-500 outline-none transition-all text-black font-medium text-lg shadow-sm"
              />
              <Search className="absolute left-5 top-1/2 -translate-y-1/2 text-slate-400" size={24} />
            </div>

            <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
              {categories.map(cat => (
                <button
                  key={cat}
                  onClick={() => setSelectedCategory(cat)}
                  className={`px-6 py-2.5 rounded-full font-bold text-sm whitespace-nowrap transition-all border-2 ${selectedCategory === cat ? 'bg-green-600 border-green-600 text-white shadow-lg' : 'bg-white border-slate-100 text-slate-600 hover:border-green-200'}`}
                >
                  {cat}
                </button>
              ))}
            </div>
          </div>

          {/* Medicine Grid */}
          <div className="grid sm:grid-cols-2 gap-6">
            {filteredMeds.map(med => (
              <div key={med.id} className="bg-white border border-slate-100 rounded-[2rem] p-6 shadow-sm hover:shadow-xl transition-all group relative overflow-hidden">
                <div className="flex justify-between items-start mb-4">
                  <div className="w-20 h-20 bg-slate-50 rounded-2xl flex items-center justify-center text-4xl shadow-inner group-hover:scale-110 transition-transform">
                    {med.image}
                  </div>
                  <div className="flex flex-col items-end gap-1">
                    <span className="text-[10px] font-black text-slate-400 uppercase bg-slate-100 px-3 py-1.5 rounded-lg tracking-widest">
                      {med.category}
                    </span>
                    {med.requiresPrescription && (
                      <span className="text-[8px] font-black text-red-600 uppercase bg-red-50 border border-red-100 px-2 py-0.5 rounded-md flex items-center gap-1">
                        <FileText size={10} /> Rx Required
                      </span>
                    )}
                  </div>
                </div>
                <div>
                  <h3 className="text-2xl font-bold text-slate-900 group-hover:text-green-600 transition-colors tracking-tight">{med.name}</h3>
                  <p className="text-base text-slate-500 font-medium">{med.brand}</p>
                  <div className="mt-6 flex items-center justify-between">
                    <div>
                      <span className="text-[10px] block font-black text-slate-400 uppercase mb-1">Price</span>
                      <span className="text-3xl font-black text-slate-900">â‚¹{med.price}</span>
                    </div>
                    <button 
                      onClick={() => addToCart(med.id)}
                      className="bg-slate-100 hover:bg-green-600 hover:text-white p-4 rounded-2xl transition-all shadow-sm active:scale-90"
                    >
                      <Plus size={24} />
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* AI Sidebar */}
        <div className="lg:col-span-1 space-y-6">
          <div className="bg-slate-900 rounded-[2.5rem] p-8 text-white space-y-8 shadow-2xl flex flex-col sticky top-24 h-fit max-h-[calc(100vh-120px)] overflow-hidden">
            <div className="flex items-center gap-3 shrink-0">
              <div className="bg-blue-600 p-2 rounded-xl">
                <Store size={24} />
              </div>
              <div>
                <h2 className="text-xl font-black uppercase tracking-tight">AI Scanned Centres</h2>
                <span className="text-[10px] text-blue-400 font-bold uppercase tracking-widest">Live Grounding Enabled</span>
              </div>
            </div>

            {loadingStores ? (
              <div className="flex-grow flex flex-col items-center justify-center space-y-4 py-20">
                <Loader2 className="animate-spin text-blue-500" size={48} />
                <p className="text-slate-400 font-medium animate-pulse text-center">Scanning nearby medical <br /> centres & pharmacies...</p>
              </div>
            ) : stores ? (
              <div className="flex-grow space-y-6 overflow-y-auto pr-2 custom-scrollbar">
                <div className="prose prose-invert prose-sm">
                  <p className="text-slate-300 leading-relaxed font-medium">
                    {stores.text}
                  </p>
                </div>
                <div className="space-y-3">
                  {stores.links.map((link, i) => (
                    <a key={i} href={link} target="_blank" rel="noopener noreferrer" className="flex items-center justify-between bg-white/5 border border-white/10 p-4 rounded-2xl hover:bg-white/10 transition-all">
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-green-600/20 rounded-xl flex items-center justify-center text-green-500 font-black">
                          {i + 1}
                        </div>
                        <span className="font-bold text-sm">Open Map View</span>
                      </div>
                      <ChevronRight className="text-slate-600" size={20} />
                    </a>
                  ))}
                </div>
              </div>
            ) : (
              <div className="flex-grow flex flex-col items-center justify-center text-center space-y-6 py-10">
                <MapPin className="text-slate-700" size={48} />
                <p className="text-slate-500 font-bold px-4">Waiting for location access to start scan...</p>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Cart Drawer & Ordering Flow */}
      {isCartOpen && (
        <div className="fixed inset-0 z-[100] flex justify-end">
          <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={() => setIsCartOpen(false)}></div>
          <div className="relative w-full max-w-md bg-white h-full shadow-2xl flex flex-col animate-in slide-in-from-right duration-300 overflow-hidden">
            
            {/* Drawer Header */}
            <div className="p-8 border-b border-slate-100 flex items-center justify-between shrink-0">
              <div className="flex items-center gap-3">
                {checkoutStep !== 'cart' && checkoutStep !== 'success' && (
                  <button onClick={() => setCheckoutStep('cart')} className="p-1 hover:bg-slate-100 rounded-full">
                    <ChevronLeft size={24} />
                  </button>
                )}
                <h2 className="text-2xl font-black text-slate-900">
                  {checkoutStep === 'cart' ? 'Your Cart' : 
                   checkoutStep === 'prescription' ? 'Upload Rx' : 
                   checkoutStep === 'checkout' ? 'Order Summary' : 'Success!'}
                </h2>
              </div>
              <button onClick={() => setIsCartOpen(false)} className="p-2 hover:bg-slate-100 rounded-full transition-all">
                <X size={24} />
              </button>
            </div>

            {/* Content Area */}
            <div className="flex-grow overflow-y-auto p-8 custom-scrollbar">
              {checkoutStep === 'cart' && (
                <div className="space-y-6">
                  {cartItems.length > 0 ? (
                    cartItems.map(item => (
                      <div key={item.id} className="flex gap-4 p-4 border border-slate-100 rounded-2xl group hover:border-green-200 transition-all">
                        <div className="text-3xl bg-slate-50 w-16 h-16 rounded-xl flex items-center justify-center shadow-inner">
                          {item.image}
                        </div>
                        <div className="flex-grow">
                          <div className="flex justify-between">
                            <h4 className="font-bold text-slate-900 leading-tight">{item.name}</h4>
                            <button onClick={() => removeFromCart(item.id)} className="text-slate-300 hover:text-red-500">
                              <Trash2 size={16} />
                            </button>
                          </div>
                          <p className="text-xs text-slate-500 font-medium mb-3">{item.brand}</p>
                          <div className="flex items-center justify-between">
                            <div className="flex items-center bg-slate-100 rounded-lg p-1">
                              <button onClick={() => updateQty(item.id, -1)} className="p-1 hover:text-green-600">
                                <Minus size={14} />
                              </button>
                              <span className="w-8 text-center text-xs font-black">{item.qty}</span>
                              <button onClick={() => updateQty(item.id, 1)} className="p-1 hover:text-green-600">
                                <Plus size={14} />
                              </button>
                            </div>
                            <span className="font-black text-slate-900">â‚¹{item.price * item.qty}</span>
                          </div>
                        </div>
                      </div>
                    ))
                  ) : (
                    <div className="h-full flex flex-col items-center justify-center text-center space-y-4 opacity-40 py-20">
                      <ShoppingBag size={64} />
                      <p className="font-bold text-xl">Your cart is empty</p>
                    </div>
                  )}
                </div>
              )}

              {checkoutStep === 'prescription' && (
                <div className="space-y-8 py-4">
                  <div className="bg-blue-50 p-6 rounded-[2rem] border border-blue-100 text-center space-y-4">
                    <div className="w-16 h-16 bg-blue-600 text-white rounded-2xl flex items-center justify-center mx-auto shadow-lg">
                      <FileText size={32} />
                    </div>
                    <div className="space-y-2">
                      <h3 className="text-xl font-black text-slate-900">Prescription Required</h3>
                      <p className="text-sm text-slate-500 leading-relaxed">
                        Items like {cartItems.find(i => i.requiresPrescription)?.name} require a valid prescription for processing.
                      </p>
                    </div>
                  </div>
                  
                  <div 
                    onClick={() => fileInputRef.current?.click()}
                    className={`border-2 border-dashed rounded-[2rem] p-10 flex flex-col items-center gap-4 cursor-pointer transition-all ${prescriptionFile ? 'bg-green-50 border-green-500' : 'bg-slate-50 border-slate-200 hover:border-blue-400'}`}
                  >
                    <Upload className={prescriptionFile ? 'text-green-600' : 'text-slate-300'} size={48} />
                    <div className="text-center">
                      <p className="font-black text-slate-900">{prescriptionFile || 'Choose File or Scan'}</p>
                      <p className="text-xs text-slate-400 font-bold uppercase tracking-widest mt-1">PDF, JPG, PNG up to 10MB</p>
                    </div>
                  </div>
                </div>
              )}

              {checkoutStep === 'checkout' && (
                <div className="space-y-8">
                  {/* Delivery Address */}
                  <div className="space-y-4">
                    <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest">Delivery Address</h4>
                    <div className="p-5 bg-white border border-slate-200 rounded-2xl flex gap-4">
                      <div className="bg-blue-100 p-2 rounded-xl h-fit text-blue-600">
                        <MapPin size={20} />
                      </div>
                      <div>
                        <p className="font-bold text-slate-900">Home â€¢ Aditya Kumar</p>
                        <p className="text-xs text-slate-500 leading-relaxed mt-1">
                          91-2234-5567 ABHA Linked Address<br />
                          Block 4, South Extension Part II, New Delhi
                        </p>
                      </div>
                    </div>
                  </div>

                  {/* Payment Methods */}
                  <div className="space-y-4">
                    <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest">Payment Method</h4>
                    <div className="grid grid-cols-2 gap-3">
                      <button 
                        onClick={() => setPaymentMethod('upi')}
                        className={`p-4 rounded-2xl border-2 flex flex-col items-center gap-2 transition-all ${paymentMethod === 'upi' ? 'border-green-600 bg-green-50' : 'border-slate-100 hover:border-slate-200'}`}
                      >
                        <CreditCard size={24} className={paymentMethod === 'upi' ? 'text-green-600' : 'text-slate-400'} />
                        <span className="font-black text-sm">UPI Payment</span>
                      </button>
                      <button 
                        onClick={() => setPaymentMethod('cod')}
                        className={`p-4 rounded-2xl border-2 flex flex-col items-center gap-2 transition-all ${paymentMethod === 'cod' ? 'border-green-600 bg-green-50' : 'border-slate-100 hover:border-slate-200'}`}
                      >
                        <ShoppingBag size={24} className={paymentMethod === 'cod' ? 'text-green-600' : 'text-slate-400'} />
                        <span className="font-black text-sm">Cash on Del.</span>
                      </button>
                    </div>
                  </div>

                  {/* Price Summary */}
                  <div className="p-6 bg-slate-50 rounded-2xl space-y-3">
                    <div className="flex justify-between text-sm text-slate-500 font-medium">
                      <span>Subtotal</span>
                      <span>â‚¹{cartTotal}</span>
                    </div>
                    <div className="flex justify-between text-sm text-slate-500 font-medium">
                      <span>Delivery Fee</span>
                      <span className="text-green-600">FREE</span>
                    </div>
                    <div className="pt-3 border-t border-slate-200 flex justify-between items-center">
                      <span className="font-black text-slate-900 text-lg">Payable Amount</span>
                      <span className="font-black text-green-600 text-2xl">â‚¹{cartTotal}</span>
                    </div>
                  </div>
                </div>
              )}

              {checkoutStep === 'success' && (
                <div className="h-full flex flex-col items-center justify-center text-center space-y-6 py-10 animate-in zoom-in duration-500">
                  <div className="w-32 h-32 bg-green-100 text-green-600 rounded-full flex items-center justify-center relative">
                    <CheckCircle2 size={64} />
                    <div className="absolute inset-0 bg-green-400/20 rounded-full animate-ping"></div>
                  </div>
                  <div>
                    <h3 className="text-3xl font-black text-slate-900 tracking-tight">Order Placed!</h3>
                    <p className="text-slate-500 font-medium mt-2">
                      Your medicines will reach you in approx. 45 minutes.
                    </p>
                  </div>
                  <div className="w-full bg-slate-50 p-6 rounded-[2rem] border border-slate-100">
                    <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Order ID</p>
                    <p className="text-xl font-black text-blue-600">#{orders[0]?.id}</p>
                  </div>
                  <button 
                    onClick={() => setIsCartOpen(false)}
                    className="w-full py-5 bg-slate-900 text-white rounded-2xl font-black text-xl hover:bg-black transition-all"
                  >
                    Done
                  </button>
                </div>
              )}
            </div>

            {/* Sticky Actions */}
            {checkoutStep !== 'success' && cartItems.length > 0 && (
              <div className="p-8 bg-white border-t border-slate-100 shrink-0">
                {checkoutStep === 'cart' && (
                  <button 
                    onClick={handleNextStep}
                    className="w-full py-5 bg-green-600 text-white rounded-2xl font-black text-xl shadow-xl shadow-green-100 flex items-center justify-center gap-3 hover:bg-green-700 transition-all"
                  >
                    Next Step
                    <ChevronRight size={20} />
                  </button>
                )}
                {checkoutStep === 'prescription' && (
                  <button 
                    disabled={!prescriptionFile}
                    onClick={handleNextStep}
                    className="w-full py-5 bg-green-600 disabled:bg-slate-200 text-white rounded-2xl font-black text-xl shadow-xl flex items-center justify-center gap-3"
                  >
                    Continue to Checkout
                    <ChevronRight size={20} />
                  </button>
                )}
                {checkoutStep === 'checkout' && (
                  <button 
                    disabled={isOrdering}
                    onClick={placeOrder}
                    className="w-full py-5 bg-slate-900 text-white rounded-2xl font-black text-xl shadow-xl flex items-center justify-center gap-3 hover:bg-black transition-all"
                  >
                    {isOrdering ? <Loader2 className="animate-spin" /> : <PackageCheck />}
                    {isOrdering ? 'Finalizing Order...' : `Confirm & Pay â‚¹${cartTotal}`}
                  </button>
                )}
              </div>
            )}
          </div>
        </div>
      )}

      {/* Order History Modal */}
      {isHistoryOpen && (
        <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
          <div className="bg-white w-full max-w-2xl rounded-[3rem] shadow-2xl overflow-hidden animate-in zoom-in duration-300 flex flex-col max-h-[90vh]">
            <div className="p-8 bg-slate-900 text-white flex justify-between items-center">
              <div className="flex items-center gap-3">
                <Clock className="text-blue-400" />
                <h3 className="text-2xl font-black">Your Medicine Orders</h3>
              </div>
              <button onClick={() => setIsHistoryOpen(false)} className="bg-white/10 p-2 rounded-full hover:bg-white/20 transition-all">
                <X size={24} />
              </button>
            </div>

            <div className="flex-grow overflow-y-auto p-8 space-y-6">
              {orders.length > 0 ? (
                orders.map((order, i) => (
                  <div key={i} className="border border-slate-100 rounded-3xl p-6 space-y-4 hover:shadow-md transition-all">
                    <div className="flex flex-col sm:flex-row justify-between items-start gap-4 pb-4 border-b border-slate-50">
                      <div>
                        <div className="flex items-center gap-2 mb-1">
                          <span className="text-xs font-black text-blue-600 uppercase tracking-widest">#{order.id}</span>
                          <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold uppercase ${order.status === 'Delivered' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>
                            {order.status}
                          </span>
                        </div>
                        <p className="text-sm text-slate-400 font-bold">{order.date}</p>
                      </div>
                      <div className="text-right w-full sm:w-auto">
                        <span className="text-2xl font-black text-slate-900">â‚¹{order.total}</span>
                      </div>
                    </div>
                    <div className="space-y-2">
                      {order.items.map((item, idx) => (
                        <div key={idx} className="flex justify-between items-center text-sm font-medium text-slate-600">
                          <span>{item.name} <span className="text-slate-400">Ã—{item.qty}</span></span>
                        </div>
                      ))}
                    </div>
                    {order.status !== 'Delivered' && (
                      <div className="pt-4 flex items-center gap-3 text-blue-600">
                        <Truck size={20} className="animate-bounce" />
                        <span className="text-sm font-black uppercase tracking-tight">Out for Delivery â€¢ Arriving Soon</span>
                      </div>
                    )}
                  </div>
                ))
              ) : (
                <div className="py-20 text-center space-y-4 opacity-40">
                   <Clock size={64} className="mx-auto" />
                   <p className="text-xl font-black">No orders found</p>
                </div>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default PharmacyView;
